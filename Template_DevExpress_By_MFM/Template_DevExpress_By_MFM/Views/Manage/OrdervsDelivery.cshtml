@using Template_DevExpress_By_MFM.Models
@{
    ViewBag.Title = "Order vs Delivery";
}


<!-- Left Sidebar End -->
<!-- ============================================================== -->
<!-- Start right Content here -->
<!-- ============================================================== -->
<!-- Start content -->
<style>
    .widget-container {
        margin-right: 320px;
    }

    .content h4 {
        margin-bottom: 10px;
        font-weight: 500;
        font-size: 18px;
    }

    .content {
        margin-top: 50px;
        margin-left: 10px;
    }

    .selected-item {
        margin-bottom: 20px;
    }

    #selected-files {
        display: none;
    }

    .options {
        padding: 20px;
        background-color: rgba(191, 191, 191, 0.15);
        position: absolute;
        right: 0;
        top: 0;
        bottom: 0;
        width: 260px;
    }

    .caption {
        font-size: 18px;
        font-weight: 500;
    }

    .option {
        margin-top: 10px;
    }

    .dx-datagrid-rowsview .column_class {
        text-align: left !important;
    }
</style>


<div class="content">
    <div class="container-fluid" style="padding-bottom:-300px;">
        <div class="page-title-box">
            <div class="row align-items-center">
                <div class="col-sm-4">
                    <h4 class="page-title">Price Quotation</h4>
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="javascript:void(0);">Home</a></li>
                        <li class="breadcrumb-item" active><a href="javascript:void(0);">Tableau Marketing</a></li>
                    </ol>

                </div>
            </div>
        </div>
    </div>

    <input type="text" id="temp_id" hidden />

    <div class="row">
        <div class="col-12" id="table-data-alatvm">

            <div id="player" class='tableauPlaceholder' style='width: auto; height: 2850px;'>
                <input type="hidden" runat="server" id="hdntoken" />

                <object class='tableauViz' width='1578' height='827' style='display:none;'>
                    <param name='host_url' value='http%3A%2F%2Fgsview.gs.astra.co.id%2F' />
                    <param name='embed_code_version' value='3' />
                    <param name='site_root' value='' />
                    <param name='name' value='DeliveryOrder&#47;DashboardSummary' />
                    <param name='tabs' value='no' />
                    <param name='toolbar' value='yes' />
                    <param name='showAppBanner' value='false' />
                </object>
                @*<object class='tableauViz' name="objectid" width='100%' height='2850' style='display:none;'>
                        <param name='host_url' value='http%3A%2F%2Fgsview.gs.astra.co.id%2F' />
                        <param name='embed_code_version' value='3' />
                        <param name='site_root' value='' />
                        <param name='name' value='ProductionAchievement_16184704156200&#47;ProductionAchievementShift123' />
                        <param name='tabs' value='yes' />
                        <param name='toolbar' value='yes' />
                        <param name='origin' value='card_share_link' />
                        <param name='showAppBanner' value='false' />

                    </object>*@
            </div>

        </div>
    </div>
    <!-- container-fluid -->
</div>
<!-- content -->

@section scripts
{
    <script type="module" src="https://public.tableau.com/javascripts/api/tableau.embedding.3.latest.js"></script>
    <script type='text/javascript' src='http://gsview.gs.astra.co.id/javascripts/api/viz_v1.js'></script>
    <script>


        $(document).ready(function () {

            //let dataPopUp = document.getElementById("form-scheduled");
            //let popup = DevExpress.ui.dxPopup.getInstance(dataPopUp);
            //popup.hide();
            //load_ovd();
            getAPICont();
        });


        function load() {

            var tiketparam = $('#<%=hdntoken.ClientID%>').val();

            var divObj = document.getElementById('player');
            divObj.innerHTML = '<object class="tableauViz" name="objectid" width="100%" height="2850px" style="display:none;">' +
                '< param name = "host_url" value = "http%3A%2F%2Fgsview.gs.astra.co.id%2F" /> ' +
                '   <param name="embed_code_version" value="3" /> ' +
                '  <param name="site_root" value="" /> ' +
                ' <param name="name" value="ProductionAchievement_16184704156200&#47;ProductionAchievementShift123" /> ' +
                '<param name="tabs" value="yes" /> ' +
                '<param name="toolbar" value="yes" /> ' +
                '<param name="origin" value="card_share_link" /> ' +
                '<param name="showAppBanner" value="false" /> ' +
                '<param name="ticket"  value="' + tiketparam + '" />  ' +
                ' </object >';
        }

        function load_ovd() {
            //getAPICont();

            //var tiketparam = $('#<%=hdntoken.ClientID%>').val();
            var tiketparam = $("#temp_id").val();
            console.log(tiketparam);

            var divObj = document.getElementById('player');
            divObj.innerHTML = "<object class='tableauViz' width='1578' height='827' style='display:none;'><param name='host_url' value='http%3A%2F%2Fgsview.gs.astra.co.id%2F' /> <param name='embed_code_version' value='3' /> <param name='site_root' value='' /><param name='name' value='DeliveryOrder&#47;DashboardSummary' /><param name='tabs' value='no' /><param name='toolbar' value='yes' /><param name='showAppBanner' value='false' /> <param name='ticket'  value='" + tiketparam + "' /> </object> "+
    ' </object >';
        }

        function getAPICont() {
            var $link = '@Html.Raw(Url.Action("GetAPITableau", "api", new { urltab = "replaceroomid" }))';
            $link = $link.replace("replaceroomid", "http://gsview.gs.astra.co.id/trusted?username=gsmarketing");
            $.ajax({
            type: "GET",
            url: $link,
            beforeSend: function () {

            },
            success: function (response) {
                if (response != null) {
                    console.log(response);
                    var datatok = "";
                    if (response.data.length > 0) {
                        for (var i = 0; i < response.data.length; i++)
                        {
                            datatok += response.data[i];
                        }

                  //$("#hdntoken").val(datatok);
                        console.log(datatok);
                        //return datatok;
                        //$("#temp_id").val(datatok);

                        var divObj = document.getElementById('player');
            divObj.innerHTML = "<object class='tableauViz' width='1578' height='827' style='display:none;'><param name='host_url' value='http%3A%2F%2Fgsview.gs.astra.co.id%2F' /> <param name='embed_code_version' value='3' /> <param name='site_root' value='' /><param name='name' value='DeliveryOrder&#47;DashboardSummary' /><param name='tabs' value='no' /><param name='toolbar' value='yes' /><param name='showAppBanner' value='false' /> <param name='ticket'  value='" + datatok + "' /> </object> "+
    ' </object >';
                    }
                }
            },
            error: function (xhr, status, error) {
            }
            });
        }

        function getTokenTableau() {
            $.ajax({
                type: "POST",
                url: "http://gsview.gs.astra.co.id/trusted",
              contentType: "application/json",
              //data: `{
              //  "username": "gsmarketing",
              //  "content-type": "application/x-www-form-urlencoded",
              //}`,
              success: function (result) {
                  console.log(result);
                  $("#hdntoken").val(result);
              },
                //contentType: "application/json",
                dataType: "json"
            });

            //$.ajax({
            //  type: "POST",
            //    url: "http://gsview.gs.astra.co.id/trusted",
            //  data: JSON.stringify({ "userName": "gsmarketing", "content-type" : "application/x-www-form-urlencoded" }),
            //  contentType: "application/json",
            //  success: function (result) {
            //    console.log(result);
            //  },
            //  error: function (result, status) {
            //    console.log(result);
            //  }
            //});
        }

        function functionShowBuktiIDL() {

            let dataPopUp = document.getElementById("detail-popup");
            let popup = DevExpress.ui.dxPopup.getInstance(dataPopUp);
            popup.show();
        }

        function functionUploadIDL() {

        }

        function selectionChangedBP() {
            let dataDDL = document.getElementById("act_BP");
            let instanceDDL = DevExpress.ui.dxSelectBox.getInstance(dataDDL);
            //console.log(instanceDDL.option("value"));

            var $link = '@Html.Raw(Url.Action("http://gsview.gs.astra.co.id/trusted", "api", new { bpid = "replaceroomid" }))';
            $link = $link.replace("replaceroomid", encodeURIComponent(instanceDDL.option("value")));
            $.ajax({
            type: "POST",
            url: $link,
            beforeSend: function () {

            },
            success: function (response) {
            if (response != null) {
            if (response.data.length > 0) {
            var loadData = response.data[0];

            if (loadData != null) {
            var contact = loadData.FULN;
            var position = loadData.JOBT;



            let dataContact = document.getElementById("contact_name");
            let instanceCN = DevExpress.ui.dxTextBox.getInstance(dataContact);
            let dataPosition = document.getElementById("idl_position");
            let instancePos = DevExpress.ui.dxTextBox.getInstance(dataPosition);

            if (instanceCN.option("value") == null || instanceCN.option("value") == "") {
            instancePos.option("value", position);
            }


            instanceCN.option("value", contact);

            console.log(contact +" - "+ position);
            }
            }
            }
            },
            error: function (xhr, status, error) {
            }
            });
            }

            function clickSaveFormContinue() {
            let custName = document.getElementById("sb_cust_name");
            let instanceCustName = DevExpress.ui.dxSelectBox.getInstance(custName);

            let typebat = document.getElementById("type_battery");
            let instanceTypeBatt = DevExpress.ui.dxSelectBox.getInstance(typebat);

            let partnum = document.getElementById("part_number");
            let instancePartNumber = DevExpress.ui.dxTextBox.getInstance(partnum);

            let hafee = document.getElementById("handling_fee");
            let instanceHandlingFee = DevExpress.ui.dxNumberBox.getInstance(hafee);
            let hafee2 = document.getElementById("handling_fee2");
            let instanceHandlingFee2 = DevExpress.ui.dxNumberBox.getInstance(hafee2);
            let hafee3 = document.getElementById("handling_fee3");
            let instanceHandlingFee3 = DevExpress.ui.dxNumberBox.getInstance(hafee3);
            let hafeePlas = document.getElementById("handling_fee_plastic");
            let instanceHandlingFeePlastic = DevExpress.ui.dxNumberBox.getInstance(hafeePlas);

            let iduty = document.getElementById("import_duty");
            let instanceImportDuty = DevExpress.ui.dxNumberBox.getInstance(iduty);
            let iduty2 = document.getElementById("import_duty2");
            let instanceImportDuty2 = DevExpress.ui.dxNumberBox.getInstance(iduty2);
            let iduty3 = document.getElementById("import_duty3");
            let instanceImportDuty3 = DevExpress.ui.dxNumberBox.getInstance(iduty3);
            let idutyPlas = document.getElementById("import_duty_plastic");
            let instanceImportDutyPlastic = DevExpress.ui.dxNumberBox.getInstance(idutyPlas);

            let lme = document.getElementById("lme_lead");
            let instanceLME = DevExpress.ui.dxNumberBox.getInstance(lme);

            let pre1 = document.getElementById("premium1");
            let instancePremium1 = DevExpress.ui.dxNumberBox.getInstance(pre1);

            let pre2 = document.getElementById("premium2");
            let instancePremium2 = DevExpress.ui.dxNumberBox.getInstance(pre2);

            let pre3 = document.getElementById("premium3");
            let instancePremium3 = DevExpress.ui.dxNumberBox.getInstance(pre3);

            let plaspp = document.getElementById("plastic_pp");
            let instancePlasticPP = DevExpress.ui.dxNumberBox.getInstance(plaspp);

            let exrate = document.getElementById("ex_rate");
            let instanceExRate = DevExpress.ui.dxNumberBox.getInstance(exrate);

            let wei1 = document.getElementById("weight1");
            let instanceWeight1 = DevExpress.ui.dxNumberBox.getInstance(wei1);

            let lppfee1 = document.getElementById("lpp_fee1");
            let instanceLPPFee1 = DevExpress.ui.dxNumberBox.getInstance(lppfee1);

            let lp1 = document.getElementById("lp_1");
            let instanceLeadPremium1 = DevExpress.ui.dxNumberBox.getInstance(lp1);

            let wei2 = document.getElementById("weight2");
            let instanceWeight2 = DevExpress.ui.dxNumberBox.getInstance(wei2);

            let lppfee2 = document.getElementById("lpp_fee2");
            let instanceLPPFee2 = DevExpress.ui.dxNumberBox.getInstance(lppfee2);

            let lp2 = document.getElementById("lp_2");
            let instanceLeadPremium2 = DevExpress.ui.dxNumberBox.getInstance(lp2);

            let wei3 = document.getElementById("weight3");
            let instanceWeight3 = DevExpress.ui.dxNumberBox.getInstance(wei3);

            let lppfee3 = document.getElementById("lpp_fee3");
            let instanceLPPFee3 = DevExpress.ui.dxNumberBox.getInstance(lppfee3);

            let lp3 = document.getElementById("lp_3");
            let instanceLeadPremium3 = DevExpress.ui.dxNumberBox.getInstance(lp3);

            let wei = document.getElementById("weight");
            let instanceWeight = DevExpress.ui.dxNumberBox.getInstance(wei);

            let ppprice = document.getElementById("pp_price");
            let instancePPPrice = DevExpress.ui.dxNumberBox.getInstance(ppprice);

            let plas = document.getElementById("plastic");
            let instancePlastic = DevExpress.ui.dxNumberBox.getInstance(plas);

            let sepa = document.getElementById("separator");
            let instanceSeparator = DevExpress.ui.dxNumberBox.getInstance(sepa);

            let opp = document.getElementById("opp");
            let instanceOPP = DevExpress.ui.dxNumberBox.getInstance(opp);

            let subtotmatcos = document.getElementById("stm_cost");
            let instanceSubTotalMatCost = DevExpress.ui.dxNumberBox.getInstance(subtotmatcos);

            let plate = document.getElementById("plate");
            let instancePlate = DevExpress.ui.dxNumberBox.getInstance(plate);

            let inject = document.getElementById("injection");
            let instanceInject = DevExpress.ui.dxNumberBox.getInstance(inject);

            let assy = document.getElementById("assembling");
            let instanceAssy = DevExpress.ui.dxNumberBox.getInstance(assy);

            let chg = document.getElementById("charging");
            let instanceCharging = DevExpress.ui.dxNumberBox.getInstance(chg);

            let subtotprocos = document.getElementById("stp_cost");
            let instanceSubTotalProCost = DevExpress.ui.dxNumberBox.getInstance(subtotprocos);

            let total = document.getElementById("total");
            let instanceTotal = DevExpress.ui.dxNumberBox.getInstance(total);

            let genchar = document.getElementById("gen_charge");
            let instanceGeneralCharge = DevExpress.ui.dxNumberBox.getInstance(genchar);

            let others = document.getElementById("others");
            let instanceOthers = DevExpress.ui.dxNumberBox.getInstance(others);

            let supp = document.getElementById("support_cr");
            let instanceSupport = DevExpress.ui.dxNumberBox.getInstance(supp);

            let grandtot = document.getElementById("grand_total");
            let instanceGrandTotal = DevExpress.ui.dxNumberBox.getInstance(grandtot);

            var $link = '@Html.Raw(Url.Action("PriceQuotation", "api"))';

            //console.log("HASIL WOOOY");
            //console.log(instanceLPPFee1.option("value"));

            var dataForm = {
            //quotation_period: instanceStartDate.option("value"),
            //customer_name: instanceCustName.option("value"),
            //battery_type: instanceTypeBatt.option("value"),
            //part_number: instancePartNumber.option("value"),
            LME_lead: instanceLME.option("value"),
            premium1: instancePremium1.option("value"),
            premium2: instancePremium2.option("value"),
            premium3: instancePremium3.option("value"),
            plastic_pp: instancePlasticPP.option("value"),
            ex_rate: instanceExRate.option("value"),
            material_weight1: instanceWeight1.option("value"),
            import_duty: instanceImportDuty.option("value"),
            handling_fee: instanceHandlingFee.option("value"),
            lpp_fee1: instanceLPPFee1.option("value"),
            lead_premium1: instanceLeadPremium1.option("value"),
            material_weight2: instanceWeight2.option("value"),
            import_duty2: instanceImportDuty2.option("value"),
            handling_fee2: instanceHandlingFee2.option("value"),
            lpp_fee2: instanceLPPFee2.option("value"),
            lead_premium2: instanceLeadPremium2.option("value"),
            material_weight3: instanceWeight3.option("value"),
            import_duty3: instanceImportDuty3.option("value"),
            handling_fee3: instanceHandlingFee3.option("value"),
            lpp_fee3: instanceLPPFee3.option("value"),
            lead_premium3: instanceLeadPremium3.option("value"),
            plastic_weight: instanceWeight.option("value"),
            import_duty_plastic: instanceImportDutyPlastic.option("value"),
            handling_fee_plastic: instanceHandlingFeePlastic.option("value"),
            pp_price: instancePPPrice.option("value"),
            plastic: instancePlastic.option("value"),
            separator: instanceSeparator.option("value"),
            others_purchase: instanceOPP.option("value"),
            sub_total_mat_cost: instanceSubTotalMatCost.option("value"),
            process_plate: instancePlate.option("value"),
            process_injection: instanceInject.option("value"),
            process_assembling: instanceAssy.option("value"),
            process_charging: instanceCharging.option("value"),
            sub_total_process_cost: instanceSubTotalProCost.option("value"),
            total: instanceTotal.option("value"),
            general_charge: instanceGeneralCharge.option("value"),
            others: instanceOthers.option("value"),
            support: instanceSupport.option("value"),
            grand_total: instanceGrandTotal.option("value")
            }
            console.log(dataForm);

            $.ajax({
            type: "POST",
            data: JSON.stringify(dataForm),
            contentType: 'application/json',
            url: $link,
            beforeSend: function () {
            },
            success: function (response) {
            console.log(response);
            DevExpress.ui.notify(response.message, "success", 3000);
            let dataPopUp = document.getElementById("form-scheduled");
            let popup = DevExpress.ui.dxPopup.getInstance(dataPopUp);
            popup.hide();
            if (response != null) {
            if (response.Message == "success") {
            DevExpress.ui.notify("Data berhasil disimpan!", "success", 3000);
            let dataGrid = document.getElementById("gridContainer");
            let instanceGrid = DevExpress.ui.dxDataGrid.getInstance(dataGrid);
            instanceGrid.getDataSource().reload();
            } else {
            DevExpress.ui.notify(response.Message, "error", 3000);
            }
            }
            },
            error: function (xhr, status, error) {
            console.log(error);
            console.log(status);

            DevExpress.ui.notify(error, "error", 3000);
            }
            });
            }

            function clickUpdateFormContinue() { }

            function clickPopup() {
            let dataPopUp = document.getElementById("form-scheduled");
            let popup = DevExpress.ui.dxPopup.getInstance(dataPopUp);
            popup.show();
            }

            function clickCanceled() {
            let dataPopUp = document.getElementById("form-scheduled");
            let popup = DevExpress.ui.dxPopup.getInstance(dataPopUp);
            popup.hide();
            }

            function exporting(e) {
            var workbook = new ExcelJS.Workbook();
            var worksheet = workbook.addWorksheet('ItemPartNumber');

            DevExpress.excelExporter.exportDataGrid({
            component: e.component,
            worksheet: worksheet,
            autoFilterEnabled: true
            }).then(function () {
            workbook.xlsx.writeBuffer().then(function (buffer) {
            saveAs(new Blob([buffer], { type: 'application/octet-stream' }), 'Download-ItemPartNumber.xlsx');
            });
            });
            e.cancel = true;
            }

            function cell_numbering(cellElement, cellInfo) {
            cellElement.text(cellInfo.rowIndex + 1);
            }

            function getFileUploaderInstance() {
            return $("#file-uploader").dxFileUploader("instance");
            }

            function check_beforeupload(e) {
            //let selectTahun = document.getElementById("select-years");
            //let instanceSelectedTahun = DevExpress.ui.dxSelectBox.getInstance(selectTahun);
            //var valueTahun = instanceSelectedTahun.option("value");

            //if (valueTahun == null) {
            //    e.request.abort();
            //    DevExpress.ui.dialog.alert("Mohon untuk mengisi Tahun terlebih dahulu.", "Informasi");
            //}
            }

            function onFilesUploaded(e) {
            DevExpress.ui.dialog.alert("Proses Upload Selesai", "Informasi");
            location.reload(true);
            }

            function fileUploader_valueChanged(e) {
            var files = e.value;
            if (files.length > 0) {
            $("#selected-files .selected-item").remove();

            $.each(files, function (i, file) {
            var $selectedItem = $("<div />").addClass("selected-item");
            $selectedItem.append(
            $("<span />").html("Name: " + file.name + "<br />"),
            $("<span />").html("Size " + file.size + " bytes" + "<br />"),
            $("<span />").html("Type " + file.type + "<br />"),
            $("<span />").html("Last Modified Date: " + file.lastModifiedDate)
            );
            $selectedItem.appendTo($("#selected-files"));
            });
            $("#selected-files").show();
            }
            else
            $("#selected-files").hide();
            }

            function acceptOption_changed(e) {
            getFileUploaderInstance().option("accept", e.value);
            }

            function uploadMode_changed(e) {
            getFileUploaderInstance().option("uploadMode", e.value);
            }

            function multipleOption_changed(e) {
            getFileUploaderInstance().option("multiple", e.value);
            }


            let refreshButton;
            let uploadButton;

            function onToolbarPreparing(e) {
            var dataGrid = e.component;

            //e.toolbarOptions.items[0].showText = 'always';
            //e.toolbarOptions.items.push({
            //    location: "after",
            //    widget: "dxButton",
            //    options: {
            //        text: "Upload Excel",
            //        icon: "upload",
            //        disabled: false,
            //        onClick: onUploadBtnClick,
            //        onInitialized: function (e) {
            //            uploadButton = e.component;
            //        }
            //    }
            //});

            e.toolbarOptions.items[0].showText = 'always';
            e.toolbarOptions.items.push({
            location: "after",
            widget: "dxButton",
            options: {
            text: "Add",
            icon: "add",
            disabled: false,
            onClick: clickPopup,
            onInitialized: function (e) {
            refreshButton = e.component;
            }
            }
            });
            }

            function onUploadBtnClick() {
            document.getElementById("btn-modal-show").click();
            }

            function onRefreshBtnClick() {
            //location.reload(true);
            refreshTableDevExpress();
            }

            function refreshTableDevExpress() {
            let dataGrid = document.getElementById("gridContainer");
            let instanceDataGrid = DevExpress.ui.dxDataGrid.getInstance(dataGrid);
            var $link = '@Html.Raw(Url.Action("YearlyPlan", "api"))';

            instanceDataGrid.option('dataSource', DevExpress.data.AspNet.createStore({
            key: "id_recnum_yrpln",
            loadUrl: $link,
            insertUrl: $link,
            updateUrl: $link,
            deleteUrl: $link
            }));

            instanceDataGrid.refresh();
            }

            @*function onRefreshBtnClick() {
                     var $link = '@Html.Raw(Url.Action("itempartnumber", "api"))';
                    $.ajax({
                        type: "GET",
                        url: $link,
                        beforeSend: function () {

                        },
                        success: function (response) {
                            if (response != null) {
                                let dataGrid = document.getElementById("gridContainer");
                                let instanceDataGrid = DevExpress.ui.dxDataGrid.getInstance(dataGrid);
                                instanceDataGrid.option('dataSource', response.data);
                                instanceDataGrid.refresh();
                            }
                        },
                        error: function (xhr, status, error) {
                        }
                    });
                }*@

            function onDeleteBtnClick() {
            //let dataGrid = $("#gridContainer").dxDataGrid("instance");
            //$.when.apply($, dataGrid.getSelectedRowsData().map(function (data) {
            //    return dataGrid.getDataSource().store().remove(data.ID);
            //})).done(function () {
            //    dataGrid.refresh();
            //});
            }

            function onSelectionChanged(data) {
            //refreshButton.option("disabled", !data.selectedRowsData.length);
            }

    </script>

}